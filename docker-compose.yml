version: '3'
services: 
    envoygateway:
        container_name: envoygateway        
        image: envoyproxy/envoy-distroless:v1.26.0
        pull_policy: missing
        restart: unless-stopped
        ports:
            - "9901:9901"
            - "10000:10000"
        volumes:
            - ./Envoy/envoy.yaml:/etc/envoy/envoy.yaml
            - ./Envoy/envoy.crt:/etc/ssl/certs/envoy.crt
            - ./Envoy/envoy_key.pem:/etc/ssl/certs/envoy_key.pem
        depends_on:
          - dapr-placement
          - dcservice-dapr
          - marvelservice-dapr

    envoygateway-dapr:
        container_name: envoygateway-dapr    
        image: "daprio/daprd:1.10.5-mariner-linux-amd64"
        network_mode: "service:envoygateway"
        depends_on:
            - envoygateway
        command: ["./daprd",
          "-app-id", "envoygateway",
          "-app-port", "10000",
          "-placement-host-address", "placement:50000"
        ]   
         
    dapr-placement:
        container_name: placement
        image: "daprio/placement:1.10.5-mariner-linux-amd64"
        pull_policy: missing        
        command: ["./placement", "-port", "50000", "-log-level", "debug"]
        ports:
          - "50000:50000"
         
    webstatus:
        container_name: webstatus
        build:
            context: .
            dockerfile: WebStatus/Dockerfile
        environment:
            - ASPNETCORE_URLS=http://0.0.0.0:8080
            - HealthChecksUI__HealthChecks__0__Name=DC
            - HealthChecksUI__HealthChecks__0__Uri=http://dcservice/hc
            - HealthChecksUI__HealthChecks__1__Name=Marvel
            - HealthChecksUI__HealthChecks__1__Uri=http://marvelservice/hc
        ports: 
          - "5107:8080"

    dcservice:
        container_name: dc
        restart: unless-stopped
        build: 
            context: .
            dockerfile: DC/Dockerfile
        #ports: 
        #  - "7001:80"
        #  - "7002:443"
        environment:
            ASPNETCORE_URLS: "http://+"
            ASPNETCORE_HTTPS_PORT: "7002"
            ASPNETCORE_ENVIRONMENT: "Development"
            DOTNET_RUNNING_IN_CONTAINER : "true"
            DOTNET_SYSTEM_GLOBALIZATION_INVARIANT : "1"
        volumes:
             - ${APPDATA}\microsoft\UserSecrets\:/root/.microsoft/usersecrets
             - ${USERPROFILE}\.aspnet\https:/root/.aspnet/https/

    dcservice-dapr:
        container_name: dcservice-dapr    
        image: "daprio/daprd:1.10.5-mariner-linux-amd64"
        pull_policy: missing        
        network_mode: "service:dcservice"
        depends_on:
            - dcservice
        command: ["./daprd",
          "-app-id", "dcservice",
          "-app-port", "80",
          "-placement-host-address", "placement:50000",
          "-app-protocol", "http",
          "-enable-app-health-check",
          "-app-health-check-path", "/healhtz",
          "-app-health-probe-interval", "3",
          "-app-health-probe-timeout", "200",
          "-app-health-threshold", "2"
        ]      
      
    marvelservice:
        container_name: marvel
        restart: unless-stopped
        build: 
            context: .
            dockerfile: Marvel/Dockerfile
        #ports: 
        #  - "7003:80"
        #  - "7004:443"
        environment:
            ASPNETCORE_URLS: "http://+"
            ASPNETCORE_HTTPS_PORT: "7004"
            ASPNETCORE_ENVIRONMENT: "Development"
            DOTNET_RUNNING_IN_CONTAINER : "true"
            DOTNET_SYSTEM_GLOBALIZATION_INVARIANT : "1"
        volumes:
             - ${APPDATA}\microsoft\UserSecrets\:/root/.microsoft/usersecrets
             - ${USERPROFILE}\.aspnet\https:/root/.aspnet/https/

    marvelservice-dapr:
        container_name: marvelservice-dapr    
        image: "daprio/daprd:1.10.5-mariner-linux-amd64"
        pull_policy: missing        
        network_mode: "service:marvelservice"
        depends_on:
            - marvelservice
        command: ["./daprd",
          "-app-id", "marvelservice",
          "-app-port", "80",
          "-placement-host-address", "placement:50000",
          "-app-protocol", "http",
          "-enable-app-health-check",
          "-app-health-check-path", "/healhtz",
          "-app-health-probe-interval", "3",
          "-app-health-probe-timeout", "200",
          "-app-health-threshold", "2"
        ]                  